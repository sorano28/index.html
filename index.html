<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yui 勤務記録アプリ 完成版</title>

  <!-- デザインとライブラリ読み込み -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDK読み込み -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCPIj0_5mQ1sF6oymutLF3DUUaI2Uxw5pA",
      authDomain: "yuiapp-4836a.firebaseapp.com",
      projectId: "yuiapp-4836a",
      storageBucket: "yuiapp-4836a.firebasestorage.app",
      messagingSenderId: "561964130838",
      appId: "1:561964130838:web:027b456703d0556b6f4b37",
      measurementId: "G-XB8H2BHHK2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <style>
    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background: linear-gradient(to bottom, #e0f7fa, #ffffff);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .box {
      margin-top: 16px;
      padding: 16px;
      background: white;
      border-radius: 10px;
      box-shadow: 1px 1px 6px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    canvas {
      margin-top: 30px;
      width: 90%;
      max-width: 600px;
    }
    button {
      margin: 5px;
      padding: 10px 16px;
      font-size: 16px;
    }
  </style>
</head>

<body style="display:none;">

<!-- ログイン画面 -->
<div id="loginBox" class="box">
  <h2>ログイン or 新規登録</h2>
  <input type="email" id="email" placeholder="メールアドレス"><br><br>
  <input type="password" id="password" placeholder="パスワード"><br><br>
  <button onclick="login()">ログイン</button>
  <button onclick="signup()">新規登録</button>
</div>

<!-- アプリ本体 -->
<div id="appContainer" style="display:none;">
  <h1>Yui 勤務記録アプリ</h1>

  <div id="calendar" class="box"></div>

  <canvas id="weeklyWorkChart"></canvas>
  <canvas id="monthlyWorkChart"></canvas>
</div>

<script>
  let calendar, workChart;

  auth.onAuthStateChanged((user) => {
    if (user) {
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("appContainer").style.display = "block";
      document.body.style.display = "flex";
      initApp();
    } else {
      document.getElementById("loginBox").style.display = "block";
      document.body.style.display = "flex";
    }
  });

  function login() {
    const email = document.getElementById('email').value;
    const pw = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, pw)
      .catch(err => alert("ログイン失敗: " + err.message));
  }

  function signup() {
    const email = document.getElementById('email').value;
    const pw = document.getElementById('password').value;
    auth.createUserWithEmailAndPassword(email, pw)
      .catch(err => alert("登録失敗: " + err.message));
  }

  function initApp() {
    initCalendar();
    drawWeeklyWorkChart();
    drawMonthlyWorkChart();
  }

  function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ja',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },
    });

    loadEvents().then(events => {
      calendar.addEventSource(events);
      calendar.render();
    });
  }

  function loadEvents() {
    const user = auth.currentUser;
    if (!user) return Promise.resolve([]);

    const events = [];
    return db.collection('users').doc(user.uid)
      .collection('records')
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          events.push({
            title: '勤務あり',
            start: doc.id
          });
        });
        return events;
      });
  }

  function drawWeeklyWorkChart() {
    const user = auth.currentUser;
    if (!user) return;

    const taskTypes = ['外来', '病棟', '手術', '救急', '事務'];
    const colors = {
      '外来': 'rgba(54, 162, 235, 0.7)',
      '病棟': 'rgba(75, 192, 192, 0.7)',
      '手術': 'rgba(255, 159, 64, 0.7)',
      '救急': 'rgba(255, 99, 132, 0.7)',
      '事務': 'rgba(153, 102, 255, 0.7)'
    };

    const labels = [];
    const today = new Date();
    const dates = [];

    for (let d = 6; d >= 0; d--) {
      const date = new Date(today);
      date.setDate(today.getDate() - d);
      const dateStr = date.toISOString().split('T')[0];
      labels.push(dateStr);
      dates.push(dateStr);
    }

    db.collection('users').doc(user.uid)
      .collection('records')
      .where(firebase.firestore.FieldPath.documentId(), 'in', dates)
      .get()
      .then(snapshot => {
        const dayMap = {};
        snapshot.forEach(doc => {
          dayMap[doc.id] = doc.data();
        });

        const datasets = taskTypes.map(task => ({
          label: task,
          data: [],
          backgroundColor: colors[task]
        }));

        let totalWeekHours = 0;
        labels.forEach(dateStr => {
          const record = dayMap[dateStr] || { taskHistory: {} };
          let dayTotal = 0;
          taskTypes.forEach((task, index) => {
            const hours = record.taskHistory?.[task] || 0;
            datasets[index].data.push(hours.toFixed(2));
            dayTotal += hours;
          });
          totalWeekHours += dayTotal;
        });

        const averageHours = (totalWeekHours / 7).toFixed(2);

        if (workChart) workChart.destroy();
        const ctx = document.getElementById('weeklyWorkChart').getContext('2d');
        workChart = new Chart(ctx, {
          type: 'bar',
          data: { labels: labels, datasets: datasets },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: `1日あたりの平均勤務時間：${averageHours}時間`
              }
            },
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });
      });
  }

  function drawMonthlyWorkChart() {
    const user = auth.currentUser;
    if (!user) return;

    const taskTypes = ['外来', '病棟', '手術', '救急', '事務'];
    const totals = {
      '外来': 0,
      '病棟': 0,
      '手術': 0,
      '救急': 0,
      '事務': 0
    };
    const colors = {
      '外来': 'rgba(54, 162, 235, 0.7)',
      '病棟': 'rgba(75, 192, 192, 0.7)',
      '手術': 'rgba(255, 159, 64, 0.7)',
      '救急': 'rgba(255, 99, 132, 0.7)',
      '事務': 'rgba(153, 102, 255, 0.7)'
    };

    const today = new Date();
    const thisMonth = today.getMonth();

    db.collection('users').doc(user.uid)
      .collection('records')
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const date = new Date(doc.id);
          if (date.getMonth() !== thisMonth) return;
          const record = doc.data();
          taskTypes.forEach(task => {
            totals[task] += record.taskHistory?.[task] || 0;
          });
        });

        const ctx = document.getElementById('monthlyWorkChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: taskTypes,
            datasets: [{
              label: '月間勤務時間（時間）',
              data: taskTypes.map(t => totals[t].toFixed(2)),
              backgroundColor: taskTypes.map(t => colors[t])
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'この月の仕事内容別 合計勤務時間'
              }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      });
  }
</script>

</body>
</html>
